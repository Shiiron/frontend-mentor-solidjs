import{fromJSON as L,crossSerializeStream as U,getCrossReferenceHeader as $}from"seroval";import{CustomEventPlugin as g,DOMExceptionPlugin as w,EventPlugin as S,FormDataPlugin as R,HeadersPlugin as P,ReadableStreamPlugin as y,RequestPlugin as b,ResponsePlugin as q,URLSearchParamsPlugin as E,URLPlugin as x}from"seroval-plugins/web";import{sharedConfig as C}from"solid-js";import{provideRequestEvent as F}from"solid-js/web/storage";import{getRequestURL as v,getRequestWebStream as H,getRequestIP as D,eventHandler as N,setHeader as W}from"h3";const p="Invariant Violation",{setPrototypeOf:k=function(e,t){return e.__proto__=t,e}}=Object;class m extends Error{framesToPop=1;name=p;constructor(t=p){super(typeof t=="number"?`${p}: ${t} (see https://github.com/apollographql/invariant-packages)`:t),k(this,m.prototype)}}function h(e,t){if(!e)throw new m(t)}function z(e){let t;return new Request(v(e),{duplex:"half",method:e.method,headers:e.headers,get body(){return t||(t=H(e),t)}})}const O=Symbol("h3Event"),f=Symbol("fetchEvent"),J={get(e,t){return t===f?e:e[t]??e[O][t]}};function M(e){return e.web||(e.web={url:v(e),request:z(e)}),new Proxy({request:e.web.request,clientAddress:D(e),locals:{},[O]:e},J)}function _(e){if(!e[f]){const t=M(e);e[f]=t}return e[f]}function j(e,t){return new ReadableStream({start(n){U(t,{scopeId:e,plugins:[g,w,S,R,P,y,b,q,E,x],onSerialize(s,i){const o=i?`(${$(e)},${s})`:s;n.enqueue(new TextEncoder().encode(`${o};
`))},onDone(){n.close()},onError(s){n.error(s)}})}})}async function A(e){h(e.method==="POST",`Invalid method ${e.method}. Expected POST.`);const t=_(e),n=t.request,s=n.headers.get("x-server-id"),i=n.headers.get("x-server-instance"),o=new URL(n.url);let c,u;if(s)h(typeof s=="string","Invalid server function"),[c,u]=s.split("#");else if(c=o.searchParams.get("id"),u=o.searchParams.get("name"),!c||!u)throw new Error("Invalid request");const T=(await globalThis.MANIFEST["server-fns"].chunks[c].import())[u];let a=[];if(!i){const r=o.searchParams.get("args");r&&JSON.parse(r).forEach(l=>a.push(l))}const d=n.headers.get("content-type");d.startsWith("multipart/form-data")||d.startsWith("application/x-www-form-urlencoded")?a.push(await n.formData()):a=L(await n.json(),{plugins:[g,w,S,R,P,y,b,q,E,x]});try{const r=await F(t,()=>(C.context={event:t},T(...a)));if(!i){const l=r instanceof Error,I=new URL(n.headers.get("referer"));return new Response(null,{status:302,headers:{Location:I.toString(),...r?{"Set-Cookie":`flash=${JSON.stringify({url:o.pathname+encodeURIComponent(o.search),result:l?r.message:r,error:l,input:[...a.slice(0,-1),[...a[a.length-1].entries()]]})}; Secure; HttpOnly;`}:{}}})}return typeof r=="string"?new Response(r):(W(e,"content-type","text/javascript"),j(i,r))}catch(r){return r instanceof Response&&r.status===302?new Response(null,{status:i?204:302,headers:{Location:r.headers.get("Location")}}):r}}const X=N(A);export{X as default};
